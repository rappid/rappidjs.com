define(["js/svg/SvgElement","sprd/entity/TextConfiguration","sprd/entity/DesignConfiguration","xaml!sprd/view/svg/TextConfigurationRenderer","sprd/view/svg/DesignConfigurationRenderer","underscore","sprd/type/Vector","js/core/I18n","js/core/Bus"],function(e,t,n,r,i,s,o,u,a){var f="move",l="scale",c="resize",h="rotate",p="gesture",d=!0,v=45,m=5,g=!0,y=!0,b=7,w=!1;return e.inherit({defaults:{tagName:"g",componentClass:"configuration-viewer",configuration:null,translateX:"{_offset.x}",translateY:"{_offset.y}",rotation:"{_rotation}",rotationX:"{half(configuration.width(_scale.x))}",rotationY:"{half(configuration.height(_scale.y))}",_assetContainer:null,_scaleHandle:null,_deleteHandle:null,_rotateHandle:null,_resizeHandle:null,productViewer:null,printAreaViewer:null,product:null,_offset:"{configuration.offset}",_scale:"{configuration.scale}",_configurationWidth:"{configuration.width()}",_configurationHeight:"{configuration.height()}",_rotation:"{configuration.rotation}",_configurationValid:"{configuration.isValid()}",_globalToLocalFactor:{x:1,y:1},focused:"{isFocused()}",selected:"{isSelectedConfiguration()}",_handleWidth:15,_handleOffset:0,"_handle-Offset":-15,_handleIconScale:1,_mode:null,_rotationRadius:null,imageService:null},inject:{i18n:u,bus:a},$classAttributes:["configuration","product","printAreaViewer","assetContainer","productViewer","clipPath","imageService"],ctor:function(){this.callBase(),this.translate(0,0),this.rotate(0,0,0),this._initializeCapabilities(this.$stage.$window),this.set("_globalToLocalFactor",this.$.productViewer.globalToLocalFactor()),d&&(this.bind("_offset","change",this._transformationChanged,this),this.bind("change:_rotation",this._transformationChanged,this)),this.bind("productViewer","change:width",this._productViewerSizeChanged,this)},_initializationComplete:function(){var e=this.$.clipPath,t=e.$.transformations;t.unshift(t.removeAt(1)),this.callBase()},id:function(){return"c"+this.$cid},invert:function(e){return e*-1},_initializeCapabilities:function(e){var t=this.runsInBrowser(),n=t&&"ontouchstart"in e;this.$hasTouch=n,this.$downEvent=n?"touchstart":"mousedown",this.$moveEvent=n?"touchmove":"mousemove",this.$upEvent=n?"touchend":"mouseup",this.$clickEvent=n?"tap":"click",n&&this.set({_handleWidth:28,_handleOffset:0,"_handle-Offset":-28,_handleIconScale:1.6})},_renderFocused:function(e){e?this.addClass("focused"):this.removeClass("focused")},_initializeRenderer:function(){var s,o=this.$._assetContainer,u=this.$.configuration;u instanceof n?s=i:u instanceof t&&(s=r);if(s){this.$asset=this.createComponent(s,{configuration:u,productViewer:this.$.productViewer,configurationViewer:this,_width:"{productViewer.width}",imageService:this.$.imageService});var a=this.get("_viewMap.printArea.boundary.soft.content.svg.path.d");a?(a=this.createComponent(e,{tagName:"path",d:a}),this.$.clipPath.addChild(a),this.$._assetContainerWrapper.set("clip-path","url(#"+this.$.cv.id()+")")):(this.$._assetContainerWrapper.set("clip-path",null),this.$.clipPath.set("visible",!1)),o?o.addChild(this.$asset):this.log("No assetContainer available","error")}else this.log("Cannot create renderer for configuration","error");this.callBase()},_bindDomEvents:function(){this.callBase();var e=this,t=this.$.productViewer;if(!this.runsInBrowser())return;if(t&&t.$.editable===!0){var n=this.$._assetContainer,r=this.$._scaleHandle,i=this.$._resizeHandle,s=this.$._rotateHandle,o=this.$._moveHandle;n.bindDomEvent("click",function(){e._showKeyBoard()}),n.bindDomEvent(this.$downEvent,function(t){e._down(t,e._isGesture(t)?p:f,n)}),r&&r.bindDomEvent(this.$downEvent,function(t){e._down(t,e._isGesture(t)?p:l,r)}),i&&i.bindDomEvent(this.$downEvent,function(t){e._down(t,c)}),s&&s.bindDomEvent(this.$downEvent,function(t){e._down(t,e._isGesture(t)?p:h,s)}),o&&o.bindDomEvent(this.$downEvent,function(t){e._down(t,e._isGesture(t)?p:f,o)}),t&&this.$hasTouch&&t.bindDomEvent(this.$downEvent,function(n){t.$.selectedConfiguration===e.$.configuration&&e._isGesture(n)&&e._down(n,p)});var u=function(e){return e.preventDefault&&e.preventDefault(),!1};n.bindDomEvent(this.$clickEvent,function(e){return e.stopPropagation&&e.stopPropagation(),!1}),r&&r.bindDomEvent(this.$clickEvent,u),s&&s.bindDomEvent(this.$clickEvent,u),o&&o.bindDomEvent(this.$clickEvent,u)}},_isGesture:function(e){return this.$hasTouch&&e.touches.length>1},_productViewerSizeChanged:function(){this.set("_globalToLocalFactor",this.$.productViewer.globalToLocalFactor())},_showKeyBoard:function(){var e=this.$.productViewer.$parent;if(e)if(this.$wasSelected){var t=e.$.textArea;t&&t.$el&&t.$el.focus()}else this.$wasSelected=!0},_transformationChanged:function(){var e=this.$.configuration;e&&this._debounceFunctionCall(function(){e._setError(e._validateTransform({offset:this.$._offset,scale:this.$._scale,rotation:this.$._rotation}))},"transformationChanged")},_commitSelected:function(){this.$wasSelected=!1},_down:function(e,n,r){var i=this,u=this.$.configuration,a,d;if(!u)return;if(!this.runsInBrowser())return;if(n===p&&!w)return;if(!this.$hasTouch&&e.which!==1)return;this.$._mode!==null&&this._unbindTransformationHandler();if(this.$stage.$browser.isMobile&&u instanceof t){var v;u.$.textFlow?v=u.$.textFlow.textLength()-1:v=0,u.$.selection.set({activeIndex:v,anchorIndex:v})}var m=this.$.selected;this.$.productViewer.set("selectedConfiguration",this.$.configuration),this.$stage.focus();if(e.defaultPrevented)return;e.preventDefault&&e.preventDefault(),this.$moving=!0,this.set({_mode:n,shiftKey:!1}),d=this.$downPoint={x:this.$hasTouch?e.changedTouches[0].pageX:e.pageX,y:this.$hasTouch?e.changedTouches[0].pageY:e.pageY};var g=new o([d.x,d.y]);a=this.localToGlobalFactor();var b=u.width()/2*a.x,E=u.height()/2*a.y,S=this.getSvgRoot(),x=S.$el.createSVGPoint(),T=this.$el.getScreenCTM();x.x=u.width()/2,x.y=u.height()/2,x=x.matrixTransform(T),this.$centerPoint=new o([x.x,x.y]);if(n===f){this.$snapPoints=[];if(y){var N=u.$.printArea;if(N){var C,k,L,A;if(this.$.productViewer&&this.$.productViewer.$.product){var O=this.$.productViewer.$.product.getConfigurationsOnPrintAreas([N])||[],M=s.indexOf(O,u);M!==-1&&O.splice(M,1);for(var D=0;D<O.length;D++){var P=O[D];C=P.$.offset.$.x,k=P.$.offset.$.y,L=P.height(),A=P.width(),this.$snapPoints.push({x:C,y:k},{x:C+A/2,y:k+L/2},{x:C+A,y:k+L})}}A=N.width(),L=N.height(),this.$snapPoints.push({x:0,y:0},{x:A/2,y:L/2},{x:A,y:L})}}this.set("_offset",u.$.offset.clone())}else if(n===c)this.$textArea=u.$.textArea.clone(),x.x=0,x.y=0,x=x.matrixTransform(T),this.$topLeftPoint=new o([x.x,x.y]),this.$resizeDistanceX=d.x-x.x,this.$resizeDistanceY=d.y-x.y;else if(n===l){this.set({_scale:s.clone(u.$.scale),_offset:u.$.offset.clone()});var H=g.subtract(this.$centerPoint);this.$scaleDiagonalDistance=H.distance()}else if(n===h)this.$startRotateVector=g.subtract(this.$centerPoint),this.set("_rotationRadius",o.distance([E,b])/a.x);else if(n===p){this._resetTransformation(),this.set("_offset",u.$.offset.clone());var B=e.touches[0],j=e.touches[1],F=new o([B.pageX,B.pageY]),I=new o([j.pageX,j.pageY]),q=I.subtract(F);this.$downPoints=[F,I],this.$downVector=q,this.$rotatePoint=q.multiply(.5),this.$scaleDiagonalDistance=q.distance()}var R=this.dom(this.$stage.$window);this.$moveHandler=function(e){m=!0,i._move(e,n)},this.$upHandler=function(e){m?i._up(e,n):i.$moving=!1},this.$keyDownHandler=function(e){i._keyDown(e,n)},this.$keyUpHandler=function(e){i._keyUp(e,n)},R.bindDomEvent(this.$moveEvent,this.$moveHandler),R.bindDomEvent(this.$upEvent,this.$upHandler);if(!this.$stage.$browser.hasTouch||this.$stage.$browser.isIOS)R.bindDomEvent("keydown",this.$keyDownHandler),R.bindDomEvent("keyup",this.$keyUpHandler)},_move:function(e,t){function st(e){var t={x:e*r.$.scale.x,y:e*r.$.scale.y};n.set("_scale",t),n.set({_configurationWidth:r.width(t.x),_configurationHeight:r.height(t.y)})}if(!this.$moving)return;var n=this,r=this.$.configuration;if(!r)return;var i=this.$hasTouch?e.changedTouches[0].pageX:e.pageX,s=this.$hasTouch?e.changedTouches[0].pageY:e.pageY,u=this.globalToLocalFactor(),a=this.$downPoint.x-i,d=this.$downPoint.y-s,w,E={userInteraction:!0},S,x,T,N,C,k,L;if(t===f){var A=r.$.offset.$.x-a*u.x,O=r.$.offset.$.y-d*u.y,M=Math.max(),_=Math.max(),D,P,H,B;if(y){var j=[],F=b*u.x;if(!this.$.shiftKey){for(var I=0;I<=2;I++){D=A+I/2*r.width(),P=O+I/2*r.height();for(var q=0;q<this.$snapPoints.length;q++){var R=this.$snapPoints[q];k=D-R.x,L=P-R.y,Math.abs(k)<=F&&Math.abs(k)<Math.abs(M)&&(M=k,H=R.x),Math.abs(L)<=F&&Math.abs(L)<Math.abs(_)&&(_=L,B=R.y)}}Math.abs(M)<=F&&(A-=M,j.push({x1:H,x2:H,y1:-2e3,y2:2e3})),Math.abs(_)<=F&&(O-=_,j.push({y1:B,y2:B,x1:-2e3,x2:2e3}))}}var U=this.$.printAreaViewer.$.snapLines;U&&U.reset(j),this.$._offset.set({x:A,y:O},E)}else if(t===c)x=i-this.$topLeftPoint.components[0],w=x/this.$resizeDistanceX,r.$.textArea.set("width",this.$textArea.$.width*w),x=s-this.$topLeftPoint.components[1],w=x/this.$resizeDistanceY,r.$.textArea.set("height",this.$textArea.$.height*w),r._debouncedComposeText(),r.trigger("sizeChanged");else if(t===l){S=new o([i,s]),T=S.subtract(this.$centerPoint),x=T.distance(),w=x/this.$scaleDiagonalDistance;var z={x:w*r.$.scale.x,y:w*r.$.scale.y},W=r.$.offset.$.x,X=r.$.offset.$.y;N=r.width(z.x),C=r.height(z.y);var V=r.width(),$=r.height();this.set("_scale",z,E),this.$._offset.set({x:W+(V-N)/2,y:X+($-C)/2},E),n.set({_configurationWidth:N,_configurationHeight:C},E)}else if(t===h){var J=this.$startRotateVector;T=o.subtract([i,s],this.$centerPoint);var K=o.scalarProduct(J,T),Q=Math.acos(K/(J.distance()*T.distance()))*180/Math.PI,G=o.vectorProduct(J,T);G.components[2]<0&&(Q*=-1),Q=Math.round(r.$.rotation+Q,2),g&&!this.$.shiftKey&&(Q<0&&(Q+=360),Q%=360,Q%v<m?Q=Math.floor(Q/v)*v:v-Q%v<m&&(Q=(Math.floor(Q/v)+1)*v)),this.set("_rotation",Q,E)}else if(t===p){var Y=e.touches[0],Z=e.touches[1],et=new o([Y.pageX,Y.pageY]),tt=new o([Z.pageX,Z.pageY]),nt=tt.subtract(et),rt=Math.acos(o.scalarProduct(nt,this.$downVector)/(this.$downVector.distance()*nt.distance()))*180/Math.PI;this.$downVector[0]*nt[1]-this.$downVector[1]*nt[0]<0&&(console.log("reverse"),rt*=-1);var it=nt.multiply(.5).subtract(this.$rotatePoint);console.log(it.components,this.$._offset,r.$.offset),this.$._offset.set({x:r.$.offset.$.x-it.components[0],y:r.$.offset.$.y-it.components[1]}),this.set("_rotation",Math.round(r.$.rotation+rt,2)),st(tt.subtract(et).distance()/this.$scaleDiagonalDistance)}},_up:function(e,t){if(!this.$moving)return;var n=this.$.configuration;if(n){if(t===f){n.$.offset&&n.$.offset!==this.$._offset&&n.set("offset",this.$._offset);var r=this.$.printAreaViewer.$.snapLines;r&&r.clear()}else t===l?n.set({scale:this.$._scale,offset:this.$._offset}):t===h?n.set("rotation",this.$._rotation):t===p&&n.set({rotation:this.$._rotation,scale:this.$._scale});this.$.bus.trigger("Application.productChanged",this.$.product)}this._stopTransformation()},_keyDown:function(e,t){e.keyCode===16&&this.set("shiftKey",!0),e.keyCode===27&&(this._cancelTransformation(),e.preventDefault()),this.$asset.handleKeyDown&&this.$asset.handleKeyDown(e)},_keyUp:function(e,t){e.keyCode===16&&this.set("shiftKey",!1)},_keyPress:function(e){this.$asset.handleKeyPress&&this.$asset.handleKeyPress(e)},addChar:function(e){this.$asset.addChar&&this.$asset.addChar(e)},_stopTransformation:function(){this._unbindTransformationHandler(),this.set("_mode",null),this.$moving=!1},_unbindTransformationHandler:function(){var e=this.dom(this.$stage.$window);e.unbindDomEvent(this.$moveEvent,this.$moveHandler),e.unbindDomEvent(this.$upEvent,this.$upHandler),e.unbindDomEvent("keydown",this.$keyDownHandler),e.unbindDomEvent("keyup",this.$keyUpHandler)},_resetTransformation:function(){var e=this.$.configuration;if(e){this.set({_offset:e.$.offset,_scale:e.$.scale,_rotation:e.$.rotation}),e._validateTransform(e.$);var t=this.$.printAreaViewer.$.snapLines;t&&t.reset([])}},_cancelTransformation:function(){this._resetTransformation(),this._stopTransformation()},getButtonSize:function(e){var t=this.globalToLocalFactor();return{width:t.x*e,height:t.y*e}},pixelToViewBox:function(e){return e*this.$._globalToLocalFactor.x}.onChange("_globalToLocalFactor"),scaleIconToViewBox:function(){return.1*this.$._globalToLocalFactor.x}.onChange("_globalToLocalFactor"),deleteConfiguration:function(){if(this.$.product){var e=this.$.configuration,t=this.$.productViewer;this.$.product.$.configurations.remove(e),this.$.bus.trigger("Application.productChanged",this.$.product),t&&t.$.selectedConfiguration===e&&t.set("selectedConfiguration",null)}},substract:function(e,t){return e-t},mul:function(e,t){return e*t},half:function(e){return e/2},flipOffsetX:function(){return this.$._scale.x<0?-this.$.configuration.width():0}.onChange("_scale"),flipOffsetY:function(){return this.$._scale.y<0?-this.$.configuration.height():0}.onChange("_scale"),errorClass:function(){return this.$._configurationValid?"":"error"}.onChange("_configurationValid"),isFocused:function(){return this.isSelectedConfiguration()&&this.get("productViewer.focused")}.on(["productViewer","change:selectedConfiguration"],["productViewer","change:focused"]),isSelectedConfiguration:function(){return this.$.configuration!==null&&this.get("productViewer.editable")===!0&&this.get("productViewer.selectedConfiguration")===this.$.configuration}.on(["productViewer","change:selectedConfiguration"]),isSelectedConfigurationOrConfigurationHasError:function(){return this.$.configuration!==null&&this.get("productViewer.editable")===!0&&this.get("productViewer.selectedConfiguration")===this.$.configuration||!this.$.configuration.isValid()}.on(["productViewer","change:selectedConfiguration"],["configuration","isValidChanged"]),isScalable:function(){return this.isSelectedConfiguration()&&this.get("configuration.isScalable()")}.onChange("selected"),isResizeable:function(){return this.isSelectedConfiguration()&&this.get("configuration.type")==="text"}.onChange("selected"),isRotatable:function(){return this.isSelectedConfiguration()&&this.get("configuration.isRotatable()")}.onChange("selected"),isMovable:function(){return this.isSelectedConfiguration()}.onChange("selected"),isRemovable:function(){return this.isSelectedConfiguration()&&this.get("configuration.isRemovable()")}.onChange("selected"),isRotating:function(){return this.$._mode===h}.onChange("_mode"),hasError:function(){return!this.$.configuration.isValid()&&this.get("productViewer.editable")===!0}.on(["configuration","isValidChanged"]),errorDescription:function(){var e=null,t=this.$.configuration;if(!t||!t.$errors)return null;for(var n in t.$errors.$)if(t.$errors.$.hasOwnProperty(n)){e=t.$errors.$[n];if(e){e=n;break}}return e?this.$.i18n.ts("configurationViewer.design",e):null}.on(["configuration","isValidChanged"])})});