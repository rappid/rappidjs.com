define(["js/ui/View","js/core/Bus","sprd/manager/ProductManager","sprd/data/ImageService"],function(e,t,n,r){return e.inherit("sprd.view.ProductViewerClass",{defaults:{view:null,product:null,width:300,height:300,selectedConfiguration:null,editable:!0,focused:!0,productViewerSvg:null,textArea:null,textAreaPosition:null,removeEmptyTextConfiguration:!0,imageService:null,errorKey:"{product.configurationsOnViewErrorKey(view)}",componentClass:"product-viewer"},inject:{bus:t,productManager:n,imageService:r},events:["on:configurationSelect"],ctor:function(){this.callBase(),this.bind("productViewerSvg","add:configurationViewer",this._onConfigurationViewerAdded,this),this.bind("product.configurations","reset",this._onConfigurationsReset,this),this.bind("product","change:configurations",this._onConfigurationsReset,this),this.bind("product.configurations","remove",function(e){e.$.item===this.$.selectedConfiguration&&this.set("selectedConfiguration",null)},this),this.bind("selectedConfiguration","change:scale",this._positionTextArea,this),this.bind("selectedConfiguration","change:offset",this._positionTextArea,this)},_commitSelectedConfiguration:function(e,t){if(this.$.removeEmptyTextConfiguration&&t&&t.type==="text"&&t.$.textFlow&&this.$.product){var n=t.$.textFlow.text(0,-1);/^[\s\n\r]*$/.test(n)&&this.$.product.$.configurations.remove(t)}this._positionTextArea()},keyUp:function(e){if(!this.$stage.$browser.isIOS)return;if(this.$keyPressHandled)return;var t=this.$.textArea.$el.value;if(this.$lastValue!==t&&t&&t.length!==0){var n=t.substr(-1),r=this.$.selectedConfigurationViewer;n&&r&&r.addChar(n)}this.$lastValue=t,this.$.textArea.$el.value=""},keyPress:function(e){if(!this.$stage.$browser.isIOS)return;this.$keyPressHandled=!0,this.$.textArea.$el.value="",this._keyPressHandler(e.domEvent)},keyDown:function(e){if(!this.$stage.$browser.isIOS)return;this.$keyPressHandled=!1,this._keyDownHandler(e.domEvent)},_positionTextArea:function(){try{var e=null,t=this.$.selectedConfiguration;if(!this.$textAreaFocused&&this.$.editable&&t&&t.type==="text"&&this.$.productViewerSvg&&this.$.productViewerSvg.$currentProductTypeViewViewer){var n=this.$.productViewerSvg.localToGlobalFactor(),r=this.$.productViewerSvg.$currentProductTypeViewViewer.$._view,i;for(var s=0;s<r.$.viewMaps.$items.length;s++)if(r.$.viewMaps.$items[s].$.printArea===t.$.printArea){i=r.$.viewMaps.$items[s];break}i&&(e={x:(i.get("offset.x")+t.get("offset.x"))*n.x+14,y:(i.get("offset.y")+t.get("offset.y"))*n.y-2,width:t.width()*n.x-25,height:t.height()*n.y-10})}this.set("textAreaPosition",e)}catch(o){if(!this.$.bus)throw o;this.$.bus.trigger("Application.Error",o)}},_onConfigurationsReset:function(){this.set("selectedConfiguration",null)},_onConfigurationViewerAdded:function(e){var t=e.$;t&&(t.$.configuration===this.$.selectedConfiguration&&this.set("selectedConfigurationViewer",t),this.trigger("add:configurationViewer",t))},_clickHandler:function(e){this.$.editable&&!e.isDefaultPrevented&&!e.defaultPrevented&&e.domEvent&&e.domEvent.target!==this.$.textArea.$el&&this.set("selectedConfiguration",null),e.preventDefault(),this.set("focused",!0)},_commitChangedAttributes:function(e){this.callBase();if(e&&e.hasOwnProperty("selectedConfiguration")){var t=e.selectedConfiguration,n=null;t?n=this.getViewerForConfiguration(t):n=null,this.trigger("on:configurationSelect",t),this.set("selectedConfigurationViewer",n)}},getViewerForConfiguration:function(e){return this.$.productViewerSvg?this.$.productViewerSvg.getViewerForConfiguration(e):null},_keyDownHandler:function(e){var t=this,n=t.$.product,r=this.$.selectedConfigurationViewer;if(r){r._keyDown(e);if(e.defaultPrevented)return}var i=t.$.selectedConfiguration;if(i&&n){var s=0,o=0;switch(e.keyCode){case 40:o=1;break;case 38:o=-1;break;case 37:s=-1;break;case 39:s=1}if(s||o){e.shiftKey&&(s*=10,o*=10);var u=i.$.offset.clone();u.set({x:u.$.x+s,y:u.$.y+o}),i.set("offset",u),e.preventDefault(),e.stopPropagation()}if(e.keyCode===8||e.keyCode===46)n.$.configurations.remove(i),t.set("selectedConfiguration",null),e.preventDefault(),e.stopPropagation()}},_keyPressHandler:function(e){var t=this.$.selectedConfigurationViewer;t&&t._keyPress(e)},_bindDomEvents:function(){if(this.runsInBrowser()&&this.$.editable){var e=this;this.bind("on:click",this._clickHandler,this),this.$stage.bind("on:focus",function(){e.set("focused",!0)}),this.callBase()}},textAreaFocused:function(){this.set("focused",!0);if(this.$stage.$browser.isIOS)this.$.textArea.set("visibility","hidden");else{this.$stage.set("height",this.$stage.$el.offsetHeight);var e=this;setTimeout(function(){e._positionTextArea(),e.$.textArea.set({opacity:1,value:e.$.selectedConfiguration?e.$.selectedConfiguration.$.textFlow.text(0,-1,"\n").replace(/\n$/,""):""}),e.$.textArea.set("opacity",1)},1e3)}this.addClass("text-area-active")},_delegateEvent:function(e){if(this.$stage.$browser.isIOS||this.$.textArea.get("opacity")==0){var t=this.$.selectedConfigurationViewer;t&&t._down(e.domEvent,t._isGesture(e.domEvent)?"gesture":"move"),this.$pointerMoveEventTriggerd=!1}},_textAreaMove:function(){this.$pointerMoveEventTriggerd=!0},_endTextAreaMove:function(e){this.$pointerMoveEventTriggerd||e.target.focus()},textAreaBlured:function(){this.set("focused",!1);if(this.$stage.$browser.isIOS){this.$.textArea.set("visibility","visible");var e=this.$.selectedConfigurationViewer;e&&e.set("focused",!1)}else{var t=this;setTimeout(function(){t.$stage.set("height","100%")},200),this.$.selectedConfiguration&&this.$.productManager.setTextForConfiguration(this.$.textArea.$.value,this.$.selectedConfiguration),t.$.textArea.set("opacity",0)}this.removeClass("text-area-active")},showTextAreaOverlay:function(){return this.$.editable&&this.$.selectedConfiguration&&this.$.selectedConfiguration.type==="text"&&this.runsInBrowser()&&"ontouchstart"in window}.onChange("selectedConfiguration","editable")})});