define(["sprd/manager/IProductManager","underscore","flow","sprd/util/ProductUtil","text/entity/TextFlow","sprd/type/Style","sprd/entity/DesignConfiguration","sprd/entity/TextConfiguration","text/operation/ApplyStyleToElementOperation","text/entity/TextRange","sprd/util/UnitUtil","js/core/Bus"],function(e,t,n,r,i,s,o,u,a,f,l,c){return e.inherit("sprd.manager.ProductManager",{inject:{bus:c},setProductType:function(e,t,r,i){r instanceof Function&&(i=r,r=null);var s=this,o;n().seq(function(e){t.fetch(null,e)}).seq(function(){r||(e.$.appearance?r=t.getClosestAppearance(e.$.appearance.getMainColor()):r=t.getDefaultAppearance())}).seq(function(){var n=e.$.view;n&&(o=t.getViewByPerspective(n.$.perspective)),o||(o=t.getDefaultView())}).seq(function(){s.convertConfigurations(e,t,r)}).seq(function(){e.set({productType:t,view:o,appearance:r}),s.$.bus.trigger("Application.productChanged",e)}).exec(i)},setAppearance:function(e,t){this.convertConfigurations(e,e.$.productType,t),e.set({appearance:t}),this.$.bus&&this.$.bus.trigger("Application.productChanged",e)},convertConfigurations:function(e,n,r){var i=e.$.configurations.$items,s=[],o={silent:!0};for(var u=0;u<i.length;u++){var a=i[u],f=a.$.printArea,l=f.getDefaultView(),c=null,h=null;l&&(c=n.getViewByPerspective(l.$.perspective)),c&&(h=c.getDefaultPrintArea()),h||(h=n.getDefaultPrintArea());if(h&&a.isAllowedOnPrintArea(h)){a.set("printArea",h,o);var p=f.get("boundary.size.width"),d=f.get("boundary.size.height"),v=h.get("boundary.size.width"),m=h.get("boundary.size.height"),g=null,y,b,w=a.width(),E=a.height(),S=a.getPossiblePrintTypesForPrintArea(h,r.$.id),x=a.$.printType,T={x:a.$.offset.$.x+w/2,y:a.$.offset.$.y+E/2};x&&!t.contains(S,x)&&(x=null);if(x){var N=t.indexOf(S,x);N>=0&&S.splice(N,1),S.unshift(x)}var C=Math.min(v/p,m/d)*Math.abs(a.$.scale.x),k=a.allowScale();for(var L=0;L<S.length;L++){x=S[L];var A=C,O=null;x.isEnlargeable()&&(O=a.minimumScale());var M=a.getSizeForPrintType(x),D=Math.min(x.get("size.width")/M.$.width,x.get("size.height")/M.$.height);x.isShrinkable()&&(D=1);if(!k&&(D<1||O&&O>1))continue;if(O&&O>D)continue;O&&(A=Math.max(A,O)),A=Math.min(A,D),y={x:A,y:A},g=x;break}g?(a.set({printType:g,scale:y},o),b={x:v*T.x/p-a.width()/2,y:m*T.y/d-a.height()/2},a.$.offset.set(b,o)):s.push(a)}else s.push(a)}e.$.configurations.remove(s)},addDesign:function(e,i,s){i=t.defaults({},i,{design:null,perspective:null,view:null,printArea:null,printType:null,designColorRGBs:null,designColorIds:null});var u=this,a=this.$.bus,f=i.design,l=e.$.productType,c=i.printArea,h=i.view,p=e.$.appearance,d=i.printType;if(!f){s(new Error("No design"));return}if(!l){s(new Error("ProductType not set"));return}if(!p){s(new Error("Appearance for product not set"));return}n().par(function(e){f.fetch(null,e)},function(e){l.fetch(null,e)}).seq("printArea",function(){!c&&i.perspective&&!h&&(h=l.getViewByPerspective(i.perspective));if(!c&&h){if(!l.containsView(h))throw new Error("View not on ProductType");c=h.getDefaultPrintArea()}h=e.$.view||e.getDefaultView(),!c&&h&&(c=h.getDefaultPrintArea());if(!c)throw new Error("target PrintArea couldn't be found.");if(c.get("restrictions.designAllowed")===!1)throw new Error("designs cannot be added to this print area");return c}).seq("printType",function(){var e=r.getPossiblePrintTypesForDesignOnPrintArea(f,c,p.$.id);if(d&&!t.contains(e,d))throw new Error("PrintType not possible for design and printArea");d=d||e[0];if(!d)throw new Error("No printType available");return d}).seq(function(e){d.fetch(null,e)}).seq("designConfiguration",function(){var t=e.createEntity(o);return t.set({printType:d,printArea:c,design:f,designColorIds:i.designColorIds,designColorRGBs:i.designColorRGBs}),t}).seq(function(e){var t=this.vars.designConfiguration;a.setUp(t),t.init(e)}).seq(function(){u._positionConfiguration(this.vars.designConfiguration)}).exec(function(t,n){!t&&e._addConfiguration(n.designConfiguration),u.$.bus.trigger("Application.productChanged",e),s&&s(t,n.designConfiguration)})},addText:function(e,o,l){o=t.defaults({},o,{text:null,fontFamily:null,perspective:null,view:null,printArea:null,printType:null,fontStyle:"normal",fontWeight:"normal"});var c=this,h=e.$context.$contextModel,p=o.text,d=this.$.bus,v=e.$.productType,m=o.printArea,g=o.view,y=null,b=e.$.appearance,w=o.printType;if(!p){l(new Error("No text"));return}if(!v){l(new Error("ProductType not set"));return}if(!b){l(new Error("Appearance for product not set"));return}n().par({fontFamilies:function(e){o.fontFamily?e():h.$.fontFamilies.fetch({fullData:!0},e)},productType:function(e){v.fetch(null,e)}}).seq("fontFamily",function(){var t=o.fontFamily||this.vars.fontFamilies.at(0);if(!t)throw new Error("No found");y=t.getFont(o.fontWeight,o.fontStyle),y||e.log("Font with for required style & weight not found. Fallback to default font","warn"),y=y||t.getDefaultFont();if(!y)throw new Error("No font in family found");return t}).seq("printArea",function(){!m&&o.perspective&&!g&&(g=v.getViewByPerspective(o.perspective));if(!m&&g){if(!v.containsView(g))throw new Error("View not on ProductType");m=g.getDefaultPrintArea()}g=e.$.view||e.getDefaultView(),!m&&g&&(m=g.getDefaultPrintArea());if(!m)throw new Error("target PrintArea couldn't be found.");if(m.get("restrictions.textAllowed")===!1)throw new Error("text cannot be added to this print area");return m}).seq("printType",function(){var e=this.vars.fontFamily,n=r.getPossiblePrintTypesForTextOnPrintArea(e,m,b.$.id);if(w&&!t.contains(n,w))throw new Error("PrintType not possible for text and printArea");w=w||n[0];if(!w)throw new Error("No printType available");return w}).seq(function(e){w.fetch(null,e)}).seq("printTypeColor",function(){var t=e.appearanceBrightness()!=="dark"?"#000000":"#FFFFFF";t=w.getClosestPrintColor(t);if(!t)throw"No print type color";return t}).seq("configuration",function(){var t=i.initializeFromText(p),n=this.vars.printArea.get("size.width")*25/550;(new a(f.createTextRange(0,t.textLength()),t,new s({font:y,fontSize:25,lineHeight:1.2,printTypeColor:this.vars.printTypeColor}),new s({textAnchor:"middle"}))).doOperation();var r=e.createEntity(u);return r.set({printType:w,printArea:m,textFlow:t,selection:f.createTextRange(0,t.textLength())}),r}).seq(function(e){var t=this.vars.configuration;d.setUp(t),t.init(e)}).seq(function(){var e=this.vars.configuration;e.$.selection.set({activeIndex:e.$.textFlow.textLength()-1,anchorIndex:0}),c._positionConfiguration(e)}).exec(function(t,n){!t&&e._addConfiguration(n.configuration),l&&l(t,n.configuration),c.$.bus.trigger("Application.productChanged",e)})},setTextForConfiguration:function(e,t){if(!(t instanceof u))throw new Error("Configuration is not a TextConfiguration");var n=i.initializeFromText(e),r=f.createTextRange(0,n.textLength()),s=t.$.textFlow.getFirstLeaf(),o,l,c;s&&(o=s.$parent,l=s.$.style,o&&(c=o.$.style));var h=new a(r,n,l,c);h.doOperation(),t.set("textFlow",n),n.trigger("operationComplete",null,n),this.$.bus.trigger("Application.productChanged",null)},_positionConfiguration:function(e){var t=e.$.printArea,n=t.get("boundary.size.width"),r=t.get("boundary.size.height"),i=t.$.defaultBox||{x:0,y:0,width:n,height:r},s,o=i.x+i.width/2,u=i.y+i.height/2,a=e.$.offset.clone(),f;s=e._getBoundingBox(null,null,null,null,null,!1),a.set({x:o-s.width/2,y:i.y});if(a.$.x<0||a.$.x+s.width>n){var l=Math.min(o,n-o)*2,c=l/s.width,h=i.width/s.width;f=h,e.set("scale",{x:f,y:f}),s=e._getBoundingBox(),a.set({x:o-s.width/2,y:i.y})}if(s.height>r){var p=e.$.scale.y*r/s.height,d=e.$.scale.y*i.height/s.height;f=p,e.set("scale",{x:f,y:f}),s=e._getBoundingBox(),a.set({x:o-s.width/2,y:u-s.height/2})}(a.$.y<0||a.$.y+s.height>r)&&a.set({y:r/2-s.height/2}),e.set({offset:a})},checkConfigurationOffset:function(e,t){if(this._checkConfigurationOutsideViewPort(e,t))return;this._checkConfigurationOutsidePrintArea(e,t)},_checkConfigurationOutsidePrintArea:function(e,t){if(!e||!t)return;var n=t._getBoundingBox(),r=t.$.printArea;return n&&r&&r.hasSoftBoundary()&&(n.x>r.width()||n.x+n.width<0||n.y>r.height()||n.y+n.height<0)?(e.$.configurations.remove(t),!0):!1},_checkConfigurationOutsideViewPort:function(e,t){if(!this.$.removeConfigurationOutsideViewPort)return;if(!t||!e)return;var n=t._getBoundingBox(),r=t.$.printArea;if(!r||!n)return;if(r.hasSoftBoundary())return;var i;this.$.view&&this.$.view.containsPrintArea(r)&&(i=this.$.view),i||(i=r.getDefaultView());if(!i)return;var s=i.getViewMapForPrintArea(r);if(!s)return;var o=i.get("size.width"),u=i.get("size.height"),a={x:n.x+n.width/2+s.get("offset.x"),y:n.y+n.height/2+s.get("offset.y")};return a.x<0||a.y<0||a.x>o||a.y>u?(e.$.configurations.remove(t),!0):!1}})});