define(["js/data/DataSource","js/data/Model","flow","js/data/LocalStorage"],function(e,t,n,r){var i=new e.JsonFormatProcessor,s=e.Processor.inherit("src.data.RestDataSource.RestDataProcessor",{_composeSubModel:function(e,t,n){return{id:e.$.id}}}),o=e.inherit("js.data.LocalStorageDataSource",{defaults:{name:"default"},$defaultProcessorFactory:s,ctor:function(){this.callBase(),this.$storage=this._getStorage();if(!this.$storage)throw"Storage not available";var e=this.$storage.getItem(this.$.name);this.$data=e&&this.getFormatProcessor(null).deserialize(e)||{}},_getStorage:function(){return this.createComponent(r)},getFormatProcessor:function(e){return i},getPathComponentsForModel:function(e){if(e){var t=this.getConfigurationForModelClass(e.factory);if(t)return[t.$.path]}return null},createContext:function(e,t,n){return new o.Context(this,e,t,n)},_getCollectionData:function(e,t){if(!e){callback("path for model unknown",null,options);return}var n=[];return t&&(n=n.concat(t)),n=n.concat(e),this.$data[n.join(":")]||{}},loadCollectionPage:function(t,n,r){r=r||function(){};var i=t.getRoot(),s=this.getConfigurationForModelClass(t.$collection.$modelFactory);if(!s)throw new Error("Couldn't find path config for "+i.$modelFactory.prototype.constructor.name);var o=[s.$.path];if(!o){r("Path for model unknown",null,n);return}var u=[],a=this._getCollectionData(o,i.$context.getPathComponents());for(var f in a)a.hasOwnProperty(f)&&u.push(_.clone(this.$data[f]));var l=this.getProcessorForCollection(t);i.set("$itemsCount",u.length),u=l.parseCollection(t.getRoot(),u,e.ACTION.LOAD,n),t.add(u),r(null,t,n)},_saveModel:function(r,i,s){s=s||function(){};var o=e.ACTION.UPDATE;r._status()===t.STATE.NEW&&(o=e.ACTION.CREATE);var u=this.getProcessorForModel(r,i),a=this;n().seq(function(n){var s=u.compose(r,o,i);r._status()===t.STATE.NEW&&(s.id=e.IdGenerator.genId()),a.$data[s.id]=s;if(o===e.ACTION.CREATE){var f=a.getPathComponentsForModel(r);if(!f){n("path for model unknown");return}var l=[];l=l.concat(r.$context.getPathComponents()),l=l.concat(f);var c=a.$data[l.join(":")]||{};c[s.id]=!0,a.$data[l.join(":")]=c}a._saveStorage(),r.set("id",s.id),n()}).exec(function(e){s(e,r,i)})},loadModel:function(t,n,r){r=r||function(){};var i=this.getFormatProcessor(e.ACTION.LOAD),s=this.getProcessorForModel(t),o;if(!t.$.id){r("Model has no id");return}o=this.$data[t.$.id];if(!o){r("Could not find model");return}o=s.parse(t,o,e.ACTION.LOAD,n),t.set(o),r(null,t,n)},removeModel:function(e,t,n){n=n||function(){};var r;if(!e.$.id){n("Model has no id");return}delete this.$data[e.$.id];var i=this._getCollectionData(this.getPathComponentsForModel(e));i&&delete i[e.$.id],this._saveStorage(),n(null,e,t)},_saveStorage:function(){this.$storage.setItem(this.$.name,this.getFormatProcessor(null).serialize(this.$data))}});return o.Context=e.Context.inherit("js.data.LocalStorageDataSource.Context",{getPathComponents:function(){var e=[];if(!this.$parent)return[];e=this.$parent.getPathComponents();if(!this.$contextModel)throw new Error("ContextModel missing for non-root-Context");var t=this.$dataSource.getConfigurationForModelClass(this.$contextModel.factory);return e.push(t.$.path,this.$contextModel.$.id),e},createCollection:function(e,t,n){return t=t||{},_.defaults(t,{pageSize:Number.MAX_VALUE}),this.callBase(e,t,n)},getQueryParameters:function(){return{}}}),o});