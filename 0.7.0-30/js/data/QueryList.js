define(["js/core/List","underscore","js/data/Query","js/lib/query/ArrayExecutor","js/core/Bindable"],function(e,t,n,r,i){var s=r.Executor,o=s._getValueForItemField;return s._getValueForItemField=function(e,t){return e instanceof i?e.get(t):o(e,t)},e.inherit("js.data.QueryList",{defaults:{list:null,query:null,filterFnc:null,sortFnc:null},ctor:function(e){this.callBase([],e)},_commitChangedAttributes:function(t){this.callBase();if(t.hasOwnProperty("list")){var n=t.list;n&&n instanceof e?this._innerReset(n.$items):this._innerReset([])}(t.hasOwnProperty("query")||t.hasOwnProperty("filterFnc"))&&this._onQueryChanged()},initialize:function(){this.callBase(),this.bind("list","add",this._onItemAdded,this),this.bind("list","remove",this._onItemRemoved,this),this.bind("list","item:change",this._onItemChanged,this),this.bind("list","reset",this._onReset,this),this.bind("list","sort",this._onSort,this)},_onQueryChanged:function(){this._innerReset(this.$.list?this.$.list.$items:[])},_onReset:function(){this._innerReset(this.$.list?this.$.list.$items:[])},_onItemAdded:function(e){var t=this._filterItem(e.$.item,e.index);if(t===!0){var n=e.$.index,r=this._sortItems(this.$items.concat([e.$.item]));r&&(n=r.indexOf(e.$.item));var i=this.size();n>=i&&(n=i-1),this.add(e.$.item,{index:n})}},_sortItems:function(e){if(e){if(this._queryHasSort())return s.sortItems(this.$.query,e);if(this.$.sortFnc)return e.sort(this.$.sortFnc)}return null},_onItemRemoved:function(e){this.remove(e.$.item,e.$.index)},_onItemChanged:function(e){var n=this._filterItem(e.$.item,e.$.index),r=t.include(this.$.list.$items,e.$.item);if(r&&n===!1)this.remove(e.$.item,e.$.index);else if(!r&&n===!0){var i=e.$.index,o=this._sortItems(this.$items.concat([e.$.item]));o&&(i=o.indexOf(e.$.item)),this.add(e.$.item,{index:i})}else if(r&&n===!0&&this._queryHasSort()){o=s.sortItems(this.$.query,this.$items),i=o.indexOf(e.$.item);var u=this.indexOf(e.$.item);u!==i&&(this.removeAt(u),this.add(e.$.item,{index:i}))}},_innerReset:function(e){var t=[],n;for(var r=0;r<e.length;r++)n=e[r],this._filterItem(n,r)===!0&&t.push(n);t=this._sortItems(t)||t,this.reset(t)},_queryHasSort:function(){return this.$.query&&this.$.query.hasSortExpressions()||this.$.sortFnc},_filterItem:function(e,t){var n=!0;return this.$.filterFnc&&(n=n&&this.$.filterFnc.call(this,e,t,this)),this.$.query&&(n=n&&!!s._filterItem(e,this.$.query.where())),n}})});