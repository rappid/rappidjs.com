define(["xaml!js/svg/SvgDescriptor","js/svg/SvgElement","js/core/Base"],function(e,t,n){var r=e.inherit("js.svg.Svg",{defaults:{tagName:"svg",viewBox:"0 0 100 100",hidden:null},$classAttributes:["defs","hidden"],ctor:function(){this.callBase(),this.fontManager=new r.FontManager(this),this.$svgRoot=this,this.setViewBox.apply(this,this.$.viewBox.split(" "))},setViewBox:function(e,t,n,r){this.$viewBoxX=e,this.$viewBoxY=t,this.$viewBoxWidth=n,this.$viewBoxHeight=r,this.set("viewBox",[e,t,n,r].join(" "))},localToGlobalFactor:function(){return{x:this.$.width/this.$viewBoxWidth,y:this.$.height/this.$viewBoxHeight}},globalToLocalFactor:function(){return{x:this.$viewBoxWidth/this.$.width,y:this.$viewBoxHeight/this.$.height}},save:function(){var e=this.$stage.$window,t=this.$stage.$document.createElement("div");t.appendChild(this.$el.cloneNode(!0));var n=t.innerHTML.replace(/^\<svg/,"<svg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' ");n=n.replace(/(href=['"])\/{2}/g,"$1http://");var r=new Blob([n],{type:"image/svg+xml;charset=utf-8"}),i=e.URL||e.webkitURL||e;return i.createObjectURL(r)}});return r.FontManager=n.inherit("js.svg.Svg.FontManager",{ctor:function(e){this.$svg=e,this.$fontCache={},this.callBase()},loadExternalFont:function(e,n,r){var i=this.$svg,s=this.$fontCache[e];if(!s){var o=i.$stage.$document.createElementNS(t.SVG_NAMESPACE,"text");o.textContent="SvgFontMeasurer";var u=i.$.hidden.$el;u.appendChild(o);if(/\.woff|\.eot/.test(n)){var a=i.$stage.$document,f=a.getElementsByTagName("body")[0],l=a.getElementsByTagName("head")[0],c=a.createElement("style");c.setAttribute("type","text/css");var h="";n.indexOf(".woff")>-1?h="url('"+n+"') format('woff');":h="url('"+n+"') ;",c.innerHTML="@font-face{\nfont-family: '"+e+"';"+"src: "+h+"}\n",l.appendChild(c)}else if(n.indexOf(".svg")>-1){var p=i.$templates["external-font"].createInstance({$fontFamily:e,$src:n});i.$.defs.addChild(p)}s=this.$fontCache[e]={loaded:!1,callbacks:[r]};var d=500,v,m;setTimeout(function(){function n(){try{m=o.getBBox()}catch(e){}!m||!v||d>0&&m.x===v.x&&m.y===v.y&&m.width===v.width&&m.height===v.height?(d--,setTimeout(n,100)):(s.loaded=!0,u.removeChild(o),setTimeout(function(){for(var e=0;e<s.callbacks.length;e++)try{s.callbacks[e]&&s.callbacks[e]()}catch(t){}},200))}o.setAttribute("font-family","__ABCDE__");try{v=o.getBBox()}catch(t){}o.setAttribute("font-family",e),setTimeout(n,0)},100)}else s.loaded?r&&r():s.callbacks.push(r)}}),r});