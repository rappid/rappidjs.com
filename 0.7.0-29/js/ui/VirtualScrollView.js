define(["js/ui/View","js/core/Bindable","js/core/List","js/data/Collection","underscore"],function(e,t){return e.inherit("js.ui.VirtualScrollView",{defaults:{scrollTop:0,scrollLeft:0,updateHeightPolicy:"in",updateWidthPolicy:"in",componentClass:"scroll-container",vertical:!0,horizontal:!1,mouseTracking:!1},ctor:function(){this.callBase(),this.$mouseWheelMult=1;var e=this.get(this.$stage.$window,"navigator.userAgent");e&&(this.$isChrome=e.toLowerCase().indexOf("chrome")>-1,this.$isFirefox=e.toLowerCase().indexOf("firefox")>-1,this.$isChrome&&(this.$mouseWheelMult=.1)),this.$speed={x:0,y:0},this.$currentPos={x:0,y:0},this.$newPos={x:0,y:0},this.$mousePos={x:0,y:0},this.$trackedPos={x:0,y:0},this.$isPositiv={x:!1,y:!1},this.$isOutOfBounce={x:!1,y:!1},this.$mult={x:0,y:0},this.$delta={width:0,height:0},this.$isMouseDown=!1,this.$isScrolling=!1,this.$t=(new Date).getTime(),this.$currentT={x:0,y:0},this.$keepInBounceInterval=null,this.$trackSpeedInterval=null,this.$speedInterval={x:null,y:null},this.$propertyMap={x:"offsetWidth",y:"offsetHeight"},this.$axisScrollMap={x:"scrollLeft",y:"scrollTop"},this.$fixAxis={x:!1,y:!1},this.$transformProperty=null,this.$blockMouseWheelTimeout=null,this.$blockMouseWheel=!1},_getTransformProperty:function(e){var t=["transform","WebkitTransform","msTransform","MozTransform","OTransform"],n;while(n=t.shift())if(typeof e.style[n]!="undefined")return n;return!1},_startTracking:function(e,t){this.$speedInterval.x&&clearInterval(this.$speedInterval.x),this.$speedInterval.y&&clearInterval(this.$speedInterval.y),this.$t=(new Date).getTime(),this.$mousePos.x=e,this.$mousePos.y=t,this.$isMouseDown=!0},_initSpeedInterval:function(e,t){this.$speedInterval[e]&&clearInterval(this.$speedInterval[e]),this.$speed[e]=(this.$trackedPos[e]-this.$newPos[e])/t;if(this.$speed[e]!==0){var n=this.$speed[e]*.02,r;this.$isPositiv[e]=this.$speed[e]>=0;var i=this;this.$speedInterval[e]=setInterval(function(){(i.$isOutOfBounce[e]||i.$isPositiv[e]&&i.$speed[e]<=0||!i.$isPositiv[e]&&i.$speed[e]>=0)&&clearInterval(i.$speedInterval[e]),r=i.$speed[e]*((new Date).getTime()-i.$currentT[e]),e=="x"?i._moveBy(r,0):i._moveBy(0,r),i.$speed[e]=i.$speed[e]-n,i.$currentT[e]=(new Date).getTime()},1)}},_stopTracking:function(){this.$isMouseDown=!1,this.$currentT.x=this.$currentT.y=(new Date).getTime();var e=this.$currentT.x-this.$t;this.$.horizontal&&this._initSpeedInterval("x",e),this.$.vertical&&this._initSpeedInterval("y",e)},_getScrollContainer:function(){var e=this.get("$scrollContainer");if(!e)throw"implement _getScrollContainer or set cid='$scrollContainer'";return e},render:function(){var e=this.callBase();this.$scrollPane=this._getScrollContainer(),this.$transformProperty=this._getTransformProperty(e);var t=this,n=this.$propertyMap,r,i=function(e){r=t.$el[n[e]]-t.$scrollPane[n[e]],r<0&&!t.$isMouseDown&&!t.$isScrolling&&(t.$newPos[e]>0||t.$newPos[e]<r)?(t.$isOutOfBounce[e]=!0,t.$mult[e]=t.$newPos[e]>0?-1:1,t.$newPos[e]=t.$newPos[e]+.03*t.$el[n[e]]*t.$mult[e],t.$newPos[e]<0&&t.$mult[e]<0&&(t.$newPos[e]=0),t.$newPos[e]>r&&t.$mult[e]>0&&(t.$newPos[e]=r),t.updatePosition(t.$newPos.x,t.$newPos.y),t.$currentPos[e]=t.$newPos[e]):t.$isOutOfBounce[e]=!1};return this.$keepInBounceInterval=setInterval(function(){t.$.horizontal&&i("x"),t.$.vertical&&i("y")},20),this.$trackSpeedInterval=setInterval(function(){t.$isMouseDown&&(t.$t=(new Date).getTime()),t.$trackedPos.x=t.$newPos.x,t.$trackedPos.y=t.$newPos.y},100),e},_calculateDelta:function(e,t){if(e===0||!this.$isMouseDown)return e;var n=this.$el[this.$propertyMap[t]]-this.$scrollPane[this.$propertyMap[t]];if(e>0){if(this.$mousePos[t]>this.$el[this.$propertyMap[t]]||n>0)return 0;if(this.$currentPos[t]>0||this.$currentPos[t]<n)return e*((this.$el[this.$propertyMap[t]]-this.$mousePos[t])/this.$el[this.$propertyMap[t]])}else{if(this.$mousePos[t]<0||n>0)return 0;if(this.$currentPos[t]>0||this.$currentPos[t]<n)return e*(this.$mousePos[t]/this.$el[this.$propertyMap[t]])}return e},_moveBy:function(e,t){var n=this._calculateDelta(e*this.$.horizontal,"x"),r=this._calculateDelta(t*this.$.vertical,"y");Math.abs(e)>Math.abs(t)?r=0:n=0,this.$newPos.x=this.$currentPos.x-n,this.$newPos.y=this.$currentPos.y-r,this.updatePosition(this.$newPos.x,this.$newPos.y),this.$currentPos.x=this.$newPos.x,this.$currentPos.y=this.$newPos.y},_onWheel:function(e){},_posToCss:function(e,t){return"translate3d("+e+"px,"+t+"px,0px)"},updatePosition:function(e,t){this._setCssTranslate(-e,-t)},_setCssTranslate:function(e,t){this.$scrollPane.isRendered()&&(this.$scrollPane.$el.style[this.$transformProperty]=this._posToCss(e,t))},_bindDomEvents:function(e){this.callBase();var t=this;if(e.hasOwnProperty("ontouchstart"))this.bindDomEvent("touchstart",function(e){e.touches.length==1&&(t._startTracking(e.touches[0].clientX,e.touches[0].clientY),e.preventDefault())}),this.bindDomEvent("touchmove",function(e){e.touches.length==1&&t.$isMouseDown&&(t._moveBy(e.touches[0].clientX-t.$mousePos.x,e.touches[0].clientY-t.$mousePos.y)&&e.stopPropagation(),t.$mousePos.x=e.touches[0].clientX,t.$mousePos.y=e.touches[0].clientY)}),this.bindDomEvent("touchend",function(e){t._stopTracking()});else{this.$.mouseTracking&&(this.bindDomEvent("mousemove",function(e){t.$isMouseDown&&(t._moveBy(e.clientX-t.$mousePos.x,e.clientY-t.$mousePos.y),t.$mousePos.x=e.clientX,t.$mousePos.y=e.clientY,e.preventDefault())}),this.bindDomEvent("mousedown",function(e){t._startTracking(e.clientX,e.clientY)}),this.bindDomEvent("mouseup",function(e){t._stopTracking()}));var n=function(e){e=e||window.event;var n=0,r=0;e.wheelDeltaX&&(n=e.wheelDeltaX*2),e.wheelDeltaY&&(r=e.wheelDeltaY*2);var i=e.detail?e.detail*-3:e.wheelDelta;e.axis&&e.axis==1?n=i*t.$mouseWheelMult:r=i*t.$mouseWheelMult,t.$blockMouseWheel||t._moveBy(-n,-r),e.preventDefault()}}}})});