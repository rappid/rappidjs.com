define(["sprd/manager/IBasketManager","flow","sprd/model/Basket","xaml!sprd/data/SprdApiDataSource","js/data/LocalStorage","js/data/Entity"],function(e,t,n,r,i,s){return e.inherit("sprd.manager.ApiBasketManager",{defaults:{basket:null,apiBasketId:null,shop:null,continueShoppingLink:null,editBasketItemLinkTemplate:null,originId:null},events:["on:basketChanged","on:basketUpdated","on:basketUpdating"],inject:{api:r,localStorage:i},addElementToBasket:function(e,t,n){if(this.$.basket){var r=this.$.basket.addElement(e,t);e=r.$.element;var i=this.$.originId;i&&r.set("origin",new s({id:i}));var o=this.$.continueShoppingLink;o&&e.set("continueShoppingLink",o);var u=this.$.editBasketItemLinkTemplate;u&&e.set("editLink",u.replace("$productId",e.get("item.id")))}n&&n()},_triggerBasketChanged:function(){this.trigger("on:basketChanged",this.$.basket,this)},_triggerBasketUpdated:function(){this.trigger("on:basketUpdated",this.$.basket,this)},_triggerBasketUpdating:function(){this.trigger("on:basketUpdating",this.$.basket,this)},_initBasket:function(e){var r=this.$.api,i=this.$.localStorage,s=this.$.apiBasketId,o,u=this;s=s||i.getItem("basketId"),o=r.createEntity(n,s),this.set({basket:o,apiBasketId:s});var a=function(t){t?(console.warn(t),e(t)):(u.set("apiBasketId",s),u.$.localStorage.setItem("basketId",o.$.id),u._triggerBasketChanged(),u.fetchBasketDiscounts(e))};o.isNew()?(o.set({shop:this.$.shop,currency:this.get("shop.currency")}),o.save(null,a)):t().seq(function(e){o.fetch({noCache:!0,fetchSubModels:["currency"]},e)}).seq(function(e){u.fetchBasketDiscounts(e)}).exec(function(n){n?(o.set("id",undefined),o.save(null,a),console.warn(n)):(u.set("shop",o.$.shop),t().parEach(o.$.basketItems.toArray(),function(e,t){e.$.element.getProduct().fetch({fetchSubModels:["productType"]},t)}).exec(e))})},fetchBasketDiscounts:function(e){var t=this.$.basket;if(t.$.discounts&&t.$.discounts.size()){var n=t.$.discounts.at(0);n&&n.$.discountScale?n.$.discountScale.fetch(null,e):e()}else e()},saveBasketItem:function(e){var t=this;this.$itemSaveTimeout&&clearTimeout(this.$itemSaveTimeout),this.$itemSaveTimeout=setTimeout(function(){e.save(null,function(){t.$.basket.fetch({noCache:!0})}),t._triggerBasketChanged()},300)},removeBasketItem:function(e){this.$.basket.$.basketItems.remove(e),this.saveBasketDebounced()},saveBasketDebounced:function(){this._triggerBasketUpdating(),this._debounceFunctionCall(function(){this.saveBasket()},"saveBasketCall",700,this)},saveBasket:function(e){if(!this.$savingBasket){this._triggerBasketUpdating(),this.$savingBasket=!0,this.$callSaveBasketAgain=!1,this.$saveCallbacks=this.$saveCallbacks||[],e&&this.$saveCallbacks.push(e);var n=this,r=this.$.basket;function i(e,t){var r;while(n.$saveCallbacks&&n.$saveCallbacks.length)r=n.$saveCallbacks.shift(),r&&r(e,t)}t().seq(function(e){r.save(null,e)}).seq(function(e){n._triggerBasketChanged(),r.fetch({noCache:!0},e)}).seq(function(e){n.fetchBasketDiscounts(e)}).exec(function(e){n.$basketChanged?(n.$basketChanged=!1,n.$savingBasket=!1,n.saveBasket()):(i(e,r),n.$savingBasket=!1,n._triggerBasketUpdated())})}else e&&this.$saveCallbacks.push(e),this.$basketChanged=!0}})});