define(["js/ui/View","js/core/List","sprd/entity/FileSystemImage","flow","xaml!sprd/data/ImageServerDataSource","sprd/model/UploadImage","sprd/type/UploadDesign","sprd/data/ImageUploadService"],function(e,t,n,r,i,s,o,u){return e.inherit("sprd.view.ImageUploadClass",{defaults:{items:t,imageWidth:100,displayNotice:!0,_displayNotice:!1,uploadContext:null,enabled:!0,notice:"Drop your files here."},inject:{imageServer:i,imageUploadService:u},_initializationComplete:function(){this.callBase();var e=this,t=function(){e.set("_displayNotice",e.$.items.size()===0)};this.$.items.bind("add",t),this.$.items.bind("remove",t),this.$.items.bind("reset",t),t()},dragEnter:function(){return this.$.enabled&&this.addClass("drag-over"),!1},displayNotice:function(){return this.$.enabled&&this.$._displayNotice&&this.$.displayNotice}.onChange("displayNotice","_displayNotice","enabled"),dragOver:function(e){return e.preventDefault(),!1},dragExit:function(){return this.$.enabled&&this.removeClass("drag-over"),!1},dropImage:function(e){if(this.$.enabled){this.removeClass("drag-over");if(e&&e.$){e=e.$;if(e.dataTransfer&&e.dataTransfer.files.length)for(var t=0;t<e.dataTransfer.files.length;t++)this._addAndUploadFile(e.dataTransfer.files[t])}}return e.preventDefault(),e.stopPropagation(),!1},_addAndUploadFile:function(e,t){var n=this.uploadFile(e,t);this._addUploadDesign(n)},uploadFile:function(e,t){var r=this,i=new FileReader,s=new n({file:e}),u=new o({image:s});return i.onload=function(e){s.set("url",e.target.result)},i.readAsDataURL(e),this.$.imageUploadService._uploadDesign(u,function(e){e?r.trigger("uploadError",{error:e,uploadDesign:u}):(u.set("state",o.State.LOADED),r.trigger("uploadComplete",{uploadDesign:u})),t&&t(e,u)}),u},_addUploadDesign:function(e){this.$.items.add(e,0)}})});